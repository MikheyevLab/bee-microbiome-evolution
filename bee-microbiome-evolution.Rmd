---
title: "Bee microbiome gene expression"
author: "Sasha Mikheyev"
date: "11/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(sleuth)
library(readxl)
```

```{r}
sample_id <- dir(file.path("data/kallisto"))
metadata <- read_xlsx("data/RNA_seq_sample_metafile.xlsx") 
t2g <- read_tsv("data/gene2isoform.txt.gz", col_names = c("gene_id", "target_id"))
genesAnnotation <- read_tsv("data/genes.txt", col_names = c("beebase", "target_id", "description"), col_types = "ccc") %>% group_by(target_id) %>% mutate(description = gsub(" isoform X\\d+","", description, perl = T)) %>% unique() %>% ungroup()
go <- read_csv("data/clustered_go.csv")
```

# Model incorporating all factors at once

### Tetracycline

```{r}
TetData <- metadata %>% filter(grepl("Tetracycline", treatment)) %>%  select(sample, stress = time_stress, history) %>% mutate(path = paste0("./data/kallisto/", sample))
soTet <- sleuth_prep(TetData, extra_bootstrap_summary = T, target_mapping = t2g, aggregation_column = 'gene_id')
plot_pca(soTet, color_by = 'stress') 
soTet <- sleuth_fit(soTet, ~ stress + history, 'full')
soTet <- sleuth_fit(soTet, ~ stress, 'history')
soTet <- sleuth_lrt(soTet, 'history', 'full')
TetResults <- sleuth_results(soTet, 'history:full', 'wt', show_all = FALSE, pval_aggregate = F) %>% mutate(target_id = stringr::str_trim(target_id))
TetSignificant <- dplyr::filter(TetResults, qval <= 0.05) 
dim(TetSignificant)
left_join(TetSignificant, genesAnnotation) %>% select(target_id, qval, description)



```

### Glyphosate

```{r}
glyphData <- metadata %>% filter(grepl("Glyphosate", treatment)) %>%  select(sample, stress = time_stress, history) %>% mutate(path = paste0("./data/kallisto/", sample))
soGlyph <- sleuth_prep(glyphData, extra_bootstrap_summary = T, target_mapping = t2g, aggregation_column = 'gene_id')
plot_pca(soGlyph, color_by = 'stress') 
soGlyph <- sleuth_fit(soGlyph, ~ stress + history, 'full')
soGlyph <- sleuth_fit(soGlyph, ~ stress, 'history')
soGlyph <- sleuth_lrt(soGlyph, 'history', 'full')
glyphResults <- sleuth_results(soGlyph, 'history:full', 'lrt', show_all = FALSE)
glyphSignificant <- dplyr::filter(glyphResults, qval <= 0.05)
dim(glyphSignificant)
head(glyphSignificant, 20)
```

### Chlorothalonil

```{r}
chlorData <- metadata %>% filter(grepl("Chlorothalonil", treatment)) %>%  select(sample, stress = time_stress, history) %>% mutate(path = paste0("./data/kallisto/", sample))
soChlor <- sleuth_prep(chlorData, extra_bootstrap_summary = T, target_mapping = t2g, aggregation_column = 'gene_id')
plot_pca(soChlor, color_by = 'stress') 
soChlor <- sleuth_fit(soChlor, ~ stress + history, 'full')
soChlor <- sleuth_fit(soChlor, ~ stress, 'history')
soChlor <- sleuth_lrt(soChlor, 'history', 'full')
ChlorResults <- sleuth_results(soChlor, 'history:full', 'lrt', show_all = FALSE)
ChlorSignificant <- dplyr::filter(ChlorResults, qval <= 0.05)
dim(ChlorSignificant)
head(ChlorSignificant, 20)
```